layout: article
title: 关于php代码中一些简单的安全问题
date: 2017-03-06 23:34:02
tags:
- 过滤
- 安全
categories: TwT
---
# [TwT]关于php代码中一些简单的安全问题
第一周的分享，记录一些常见的防止漏洞的办法。
- [浅谈php过滤函数](#php)
- [数据库查询之PDO](#PDO)
---
<h2 id='php'>浅谈php过滤函数</h2>
常见的php中的过滤函数无非就那么几个
```
addslashes();
mysqli_real_escape_string();
strip_tags();
htmlspecialchars();
```
### addslashes()
首先是 `addslashes()` 这个函数，官方给的说明如下：
> string addslashes ( string $str )

> Returns a string with backslashes before characters that need to be escaped. These characters are single quote (‘), double quote (“), backslash () and NUL (the NULL byte).

> An example use of addslashes() is when you’re entering data into string that is evaluated by PHP. For example, O’Reilly is stored in $str, you need to escape $str. (e.g. eval(“echo ‘“.addslashes($str).”‘;”); )

可以看到这个函数会将字符串中的单引号，双引号，反斜杠和空字符进行转义，这个函数使用前要先确认`php.ini`中有没有开启`magic_quotes_gpc`，可以使用`get_magic_quotes_gpc()`方法进行查看，避免二次转义

### mysqli_real_escape_string()
为了防止SQL注入，这个过滤函数是必备的，由于官方的解释没找到，参考一下[W3School](http://www.w3school.com.cn/php/func_mysql_real_escape_string.asp)上的解释。
> mysql_real_escape_string() 函数转义 SQL 语句中使用的字符串中的特殊字符。
下列字符受影响：

> `\x00` `\n` `\r` `\` `'` `"` `\x1a`

> 如果成功，则该函数返回被转义的字符串。如果失败，则返回 false。

> 可以看到这个函数对数据库中比较敏感的字符都进行了转义，比如

> ```
//$connection = new mysqli("localhost", "root", "", "lms");
$str = "' OR ''='";
// print \' OR \'\'=\'
echo $connection->real_escape_string($str);
$connetion->close();
```

### strip_tags()
这个函数使用来过滤html标签的，比如：
```
$str = "Hello <b>world!</b>";
// print Hello world!
echo strip_tags($str);
```
该函数还有第二个参数，可以允许一些标签不被过滤
```
$str = "<h1>Hello <b>world!</b></h1>";
// print Hello <b>world!</b>
echo htmlspecialchars(strip_tags($str, "<b>"));
```
### htmlspecialchars()
在上一个例子上可以看出来，这个函数是转义html标签的，使得html语言正确显示，同时可以防止js的恶意攻击。
```
$str = "<script>alert("."123".");</script>";
// print <script>alert(123);</script>
echo htmlspecialchars($str);
```
---
<h2 id='PDO'>数据库查询之PDO</h2>
ThinkPHP 框架中是自带PDO这个类库的，通过PDO的参数绑定可以解决因为拼接字符串而造成的SQL注入问题。
直接上例子：
```
$dsn = 'mysql:dbname=lms;host=localhost;port=3306';
$user = "root";
$password = "";
// 创建一个PDO实例
$conncetion = new \PDO($dsn, $user, $password);
$sql = "select * from lms_user where user_number = :user";
// prepare函数是PDO在做查询之前的一个准备工作
$prepare = $conncetion->prepare($sql);
$user = "3014218099'/?or1=1'";
// bindParam方法进行参数绑定
$prepare->bindParam(":user", $user);
// excute方法执行操作
$prepare->execute();
$table = $prepare->fetchAll();
var_dump($table);
```
当然TP自带的M方法也支持参数绑定，总而言之，参数绑定可以有效的预防SQL的注入问题。

---
最后，写的不好勿喷，挽尊。
